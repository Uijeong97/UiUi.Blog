---
title: '[배포] 서버 무중단 배포하기 (In-place vs blue/green deployment)'
date: 2020-10-07 23:55:00
category: TIL
thumbnail: './images/color.png'
tags: ['TIL', '배포']
draft: false
---

> 📍 회의 때 모르는 용어가 나와서 바로 검색해서 보면 그 당시에는 이해를 한 것 같은 기분이 든다. 그런데 시간이 조금만 지나면 다 잊어버려서 정리하고자 마음 먹었다! 오늘은 서버 배포 방법에 대해 간단하게 정리해보려고 한다. 서버 무중단 배포의 방법들 중 blue/green 배포와 in-place 배포 방식을 이해하는 것을 포커스로 포스팅을 하고자 한다. 좋은 자료가 있어서, [링크](https://gist.github.com/ninanung/9d63304cb0d070642e89f9b94b6fe24b)의 내용을 토대로 재작성하였다.

## 목차
* [In-Place Deployment](#in-place-deployment)
* [Blue-Green Deployment](#blue-green-deployment)
* [Conclusion]()

## In-Place Deployment

In-Place Deployment는 무중단 배포의 한 방식이다. 직역하자면, 현재 위치에 배포한다는 의미로, 현재 가동중인 서버 그대로 무중단 배포를 구현한다는 의미이다. 우선 아래 그림을 보자.

![IMG_0584](https://user-images.githubusercontent.com/44829274/136698663-edddec2c-12d2-4f78-b4be-65f645991629.jpeg)

한 개의 로드밸런서가 4개의 서버로 골고루 요청을 보내고 있다. 모든 서버는 현재 1.0.1 버전을 사용중이며 우리의 목표는 해당 서버를 1.0.2버전으로 업데이트 하는 것이다. 순서대로 어떻게 진행되어야 하는지 한번 알아보자.

1. 로드밸런서와 Server 1과 Server 2의 연결을 해제한다. 로드밸런서는 Server 3과 Server 4로만 요청을 보내게 된다.

![IMG_0586](https://user-images.githubusercontent.com/44829274/136698910-2c4f17c0-24e8-4a3e-a7f2-0e36f7fccaab.jpeg)

2. 떼어낸 서버 두개를 버전 1.0.2로 업데이트한다. 아직 연결은 하지 않는다.

![IMG_0587](https://user-images.githubusercontent.com/44829274/136698976-6c8eb565-7c52-4181-bcca-c4eb27f8f52a.jpeg)

3. 업데이트 한 서버를 로드밸런서에 연결한다.

![IMG_0588](https://user-images.githubusercontent.com/44829274/136698984-b36e09b6-7d1e-4b7a-9bc1-b25004e20d37.jpeg)

4. 로드밸런서에 Server 3와 Server 4를 연결 해제한다. 이 단계부터 클라이언트는 1.0.2 버전의 서버를 사용할 수 있게 된다.

![IMG_0589](https://user-images.githubusercontent.com/44829274/136699001-6bc22a2c-0ffc-4817-b2b1-bbb575881752.jpeg)

5. 앞에서 진행한 2와 3을 똑같이 진행한 후 로드밸런서에 연결한다.

![IMG_0590](https://user-images.githubusercontent.com/44829274/136699008-48a24b5e-1be2-44dd-a05b-b2c5934492f1.jpeg)

짠! 사용자가 계속해서 서비스를 이용할 수 있는 상태에서 서버의 업데이트가 끝났다.

이 방식은 **현재 사용 가능한 자원을 그대로 사용하여 무중단 배포를 할 수 있다**는 장점이 있다. 서버를 증축할 필요도 없고 로드밸런서에서 해제하고 연결하는 작업을 통해 업데이트 자체도 간단하게 끝낼 수 있다. 하지만, 이 방식에는 치명적인 단점이 몇가지 있다.

1. 서버를 반으로 나눠서 업데이트 하기 때문에, 업데이트 도중에는 가용 서버가 필연적으로 적어진다.
2. 만약 1.0.2버전에 문제가 있어서 버전을 롤백해야 하는 경우 같은 방식을 통해 롤백을 따로 해야한다.

첫번째 단점은 아마 이해하기 쉬울 것이다. 네 개가 돌아가던 서버가 갑자기 두 개만 돌아가게 되면 요청이 몰리는 두 개의 서버에 부하가 걸리는 것은 당연하다. 물론 사용자가 가장 적게 몰리는 시간에 업데이트를 진행하겠지만, 마음대로 시간을 정해서 업데이트 하지 못한다는 단점은 어쨌든 생기는 것이다. 만약 사람이 적게 몰리는 시간대가 새벽이라면? 혹은 주말이라면? 누구도 야근이나 주말출근을 하고 싶어 하지 않는다.

두번째 문제는 "그냥 롤백하면 되잖아?"라고 생각할 수 있지만, 그렇게 쉽게 진행될 리 없다. 만약 1.0.2버전에 문제가 많아서 롤백과 업데이트를 반복해야 한다면? 아니, 만약 그렇지 않다고 해도 한번의 롤백에만도 `배포 -> 롤백 -> 다시 배포` 의 3단계를 똑같이 진행해야 하기 때문에 결코 효율적으로 보이지 않을 것이다. 게다가 그렇게 롤백을 하면서도 1번의 문제를 고려해야 하기 때문에 빠른 시간안에 이루어질수록 좋은 서버 업데이트 작업에 차질이 생길 수 있다. 

## Blue-Green Deployment

Blue-Green Deployment
